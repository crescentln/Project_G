name: Ruleset Auto Update

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * 1"

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Snapshot previous rule counts baseline
        run: |
          if [ -f ruleset/dist/policy_reference.json ]; then
            cp ruleset/dist/policy_reference.json /tmp/policy_reference.before.json
          fi

      - name: Build rulesets
        run: python3 ruleset/scripts/build_rulesets.py --fail-on-cross-action-conflicts

      - name: Generate recommended templates
        run: |
          python3 ruleset/scripts/generate_recommended_templates.py \
            --policy-reference ruleset/dist/policy_reference.json \
            --openclash-out ruleset/dist/recommended_openclash.yaml \
            --surge-out ruleset/dist/recommended_surge.conf \
            --raw-base-url "https://raw.githubusercontent.com/${{ github.repository }}/main/ruleset/dist"

      - name: Generate URL and source indexes
        run: |
          python3 ruleset/scripts/generate_reference_indexes.py \
            --index ruleset/dist/index.json \
            --raw-base-url "https://raw.githubusercontent.com/${{ github.repository }}/main/ruleset/dist" \
            --urls-out ruleset/dist/url_catalog.md \
            --sources-out ruleset/dist/source_authority.md

      - name: Validate output formats
        run: python3 ruleset/scripts/validate_rulesets.py

      - name: Quality gates
        run: |
          if [ -f /tmp/policy_reference.before.json ]; then
            python3 ruleset/scripts/check_quality_gates.py \
              --current ruleset/dist/policy_reference.json \
              --baseline /tmp/policy_reference.before.json \
              --fetch-report ruleset/dist/fetch_report.json \
              --conflicts ruleset/dist/conflicts.json \
              --max-change-pct 20 \
              --min-abs-delta 50 \
              --min-baseline-rules 100 \
              --minimums ruleset/config/min_rules.json \
              --max-fetch-fallbacks 0 \
              --max-cross-action-conflicts 0 \
              --max-high-severity-conflicts 0
          else
            python3 ruleset/scripts/check_quality_gates.py \
              --current ruleset/dist/policy_reference.json \
              --fetch-report ruleset/dist/fetch_report.json \
              --conflicts ruleset/dist/conflicts.json \
              --max-change-pct 20 \
              --min-abs-delta 50 \
              --min-baseline-rules 100 \
              --minimums ruleset/config/min_rules.json \
              --max-fetch-fallbacks 0 \
              --max-cross-action-conflicts 0 \
              --max-high-severity-conflicts 0
          fi

      - name: Update dist changelog
        run: |
          if [ -z "$(git status --porcelain ruleset/dist)" ]; then
            echo "No ruleset changes before changelog update."
            exit 0
          fi

          if [ -f /tmp/policy_reference.before.json ]; then
            python3 ruleset/scripts/update_dist_changelog.py \
              --current-policy ruleset/dist/policy_reference.json \
              --baseline-policy /tmp/policy_reference.before.json \
              --conflicts ruleset/dist/conflicts.json \
              --fetch-report ruleset/dist/fetch_report.json \
              --output ruleset/dist/CHANGELOG.md
          else
            python3 ruleset/scripts/update_dist_changelog.py \
              --current-policy ruleset/dist/policy_reference.json \
              --conflicts ruleset/dist/conflicts.json \
              --fetch-report ruleset/dist/fetch_report.json \
              --output ruleset/dist/CHANGELOG.md
          fi

      - name: Commit dist changes
        id: commit_dist
        run: |
          if [ -z "$(git status --porcelain ruleset/dist)" ]; then
            echo "No ruleset changes."
            echo "committed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add ruleset/dist
          git commit -m "chore(ruleset): auto update $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push
          echo "committed=true" >> "$GITHUB_OUTPUT"

      - name: Tag snapshot for rollback
        if: steps.commit_dist.outputs.committed == 'true'
        run: |
          TAG="ruleset-$(date -u +'%Y%m%dT%H%M%SZ')"
          git tag -a "$TAG" -m "ruleset snapshot $TAG"
          git push origin "$TAG"
