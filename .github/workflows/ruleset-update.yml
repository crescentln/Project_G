name: Ruleset Auto Update

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * 1"

permissions:
  contents: write

concurrency:
  group: ruleset-auto-update-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Snapshot previous rule counts baseline
        run: |
          if [ -f ruleset/dist/policy_reference.json ]; then
            cp ruleset/dist/policy_reference.json /tmp/policy_reference.before.json
          fi

      - name: Build rulesets
        timeout-minutes: 45
        run: |
          set -euo pipefail
          for attempt in 1 2 3; do
            echo "Build attempt ${attempt}/3"
            if python3 ruleset/scripts/build_rulesets.py --fail-on-cross-action-conflicts; then
              exit 0
            fi
            if [ "${attempt}" -eq 3 ]; then
              echo "Build failed after 3 attempts."
              exit 1
            fi
            echo "Retrying in 20 seconds..."
            sleep 20
          done

      - name: Generate recommended templates
        run: |
          python3 ruleset/scripts/generate_recommended_templates.py \
            --policy-reference ruleset/dist/policy_reference.json \
            --openclash-out ruleset/dist/recommended_openclash.yaml \
            --surge-out ruleset/dist/recommended_surge.conf \
            --raw-base-url "https://raw.githubusercontent.com/${{ github.repository }}/main/ruleset/dist"

      - name: Generate URL and source indexes
        run: |
          python3 ruleset/scripts/generate_reference_indexes.py \
            --index ruleset/dist/index.json \
            --raw-base-url "https://raw.githubusercontent.com/${{ github.repository }}/main/ruleset/dist" \
            --urls-out ruleset/dist/url_catalog.md \
            --sources-out ruleset/dist/source_authority.md

      - name: Validate output formats
        run: python3 ruleset/scripts/validate_rulesets.py

      - name: Smoke probes
        run: python3 ruleset/scripts/check_smoke_probes.py

      - name: Allowlist effectiveness
        run: python3 ruleset/scripts/check_allowlist_effective.py

      - name: Quality gates
        run: |
          if [ -f /tmp/policy_reference.before.json ]; then
            python3 ruleset/scripts/check_quality_gates.py \
              --current ruleset/dist/policy_reference.json \
              --baseline /tmp/policy_reference.before.json \
              --fetch-report ruleset/dist/fetch_report.json \
              --conflicts ruleset/dist/conflicts.json \
              --max-change-pct 20 \
              --min-abs-delta 50 \
              --min-baseline-rules 100 \
              --minimums ruleset/config/min_rules.json \
              --max-fetch-fallbacks 0 \
              --max-cross-action-conflicts 0 \
              --max-high-severity-conflicts 0
          else
            python3 ruleset/scripts/check_quality_gates.py \
              --current ruleset/dist/policy_reference.json \
              --fetch-report ruleset/dist/fetch_report.json \
              --conflicts ruleset/dist/conflicts.json \
              --max-change-pct 20 \
              --min-abs-delta 50 \
              --min-baseline-rules 100 \
              --minimums ruleset/config/min_rules.json \
              --max-fetch-fallbacks 0 \
              --max-cross-action-conflicts 0 \
              --max-high-severity-conflicts 0
          fi

      - name: Update dist changelog
        run: |
          if [ -z "$(git status --porcelain ruleset/dist)" ]; then
            echo "No ruleset changes before changelog update."
            exit 0
          fi

          if [ -f /tmp/policy_reference.before.json ]; then
            python3 ruleset/scripts/update_dist_changelog.py \
              --current-policy ruleset/dist/policy_reference.json \
              --baseline-policy /tmp/policy_reference.before.json \
              --conflicts ruleset/dist/conflicts.json \
              --fetch-report ruleset/dist/fetch_report.json \
              --output ruleset/dist/CHANGELOG.md
          else
            python3 ruleset/scripts/update_dist_changelog.py \
              --current-policy ruleset/dist/policy_reference.json \
              --conflicts ruleset/dist/conflicts.json \
              --fetch-report ruleset/dist/fetch_report.json \
              --output ruleset/dist/CHANGELOG.md
          fi

      - name: Commit dist changes
        id: commit_dist
        run: |
          if [ -z "$(git status --porcelain ruleset/dist)" ]; then
            echo "No ruleset changes."
            echo "committed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add ruleset/dist
          git commit -m "chore(ruleset): auto update $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push
          echo "committed=true" >> "$GITHUB_OUTPUT"

      - name: Tag snapshot for rollback
        id: tag_snapshot
        if: steps.commit_dist.outputs.committed == 'true'
        run: |
          TAG="ruleset-$(date -u +'%Y%m%dT%H%M%SZ')"
          git tag -a "$TAG" -m "ruleset snapshot $TAG"
          git push origin "$TAG"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        if: steps.commit_dist.outputs.committed == 'true'
        run: |
          python3 ruleset/scripts/generate_release_notes.py \
            --repo "${{ github.repository }}" \
            --tag "${{ steps.tag_snapshot.outputs.tag }}" \
            --changelog ruleset/dist/CHANGELOG.md \
            --index ruleset/dist/index.json \
            --conflicts ruleset/dist/conflicts.json \
            --fetch-report ruleset/dist/fetch_report.json \
            --output /tmp/ruleset-release-notes.md

      - name: Publish GitHub release
        if: steps.commit_dist.outputs.committed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.tag_snapshot.outputs.tag }}"
          TITLE="Ruleset Snapshot ${TAG}"
          if gh release view "$TAG" --repo "${{ github.repository }}" >/dev/null 2>&1; then
            gh release edit "$TAG" \
              --repo "${{ github.repository }}" \
              --title "$TITLE" \
              --notes-file /tmp/ruleset-release-notes.md
          else
            gh release create "$TAG" \
              --repo "${{ github.repository }}" \
              --title "$TITLE" \
              --notes-file /tmp/ruleset-release-notes.md
          fi

      - name: Upload diagnostics on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ruleset-debug-${{ github.run_id }}
          if-no-files-found: ignore
          path: |
            ruleset/dist/conflicts.json
            ruleset/dist/fetch_report.json
            ruleset/dist/policy_reference.json
            ruleset/dist/CHANGELOG.md

  notify-failure-email:
    if: ${{ always() && needs.build-and-publish.result == 'failure' }}
    needs:
      - build-and-publish
    runs-on: ubuntu-latest
    steps:
      - name: Check mail configuration
        id: mail_config
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL_FROM: ${{ secrets.ALERT_EMAIL_FROM }}
          ALERT_EMAIL_TO: ${{ secrets.ALERT_EMAIL_TO }}
        run: |
          set -euo pipefail
          missing=""
          for key in SMTP_SERVER SMTP_PORT SMTP_USERNAME SMTP_PASSWORD ALERT_EMAIL_FROM ALERT_EMAIL_TO; do
            if [ -z "${!key}" ]; then
              missing="${missing}${key} "
            fi
          done

          if [ -n "${missing}" ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "missing_keys=${missing}" >> "$GITHUB_OUTPUT"
          else
            echo "ready=true" >> "$GITHUB_OUTPUT"
            echo "missing_keys=" >> "$GITHUB_OUTPUT"
          fi

      - name: Send failure email
        if: steps.mail_config.outputs.ready == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[Project_G] Ruleset Auto Update failed (#${{ github.run_number }})"
          to: ${{ secrets.ALERT_EMAIL_TO }}
          from: ${{ secrets.ALERT_EMAIL_FROM }}
          body: |
            Repository: ${{ github.repository }}
            Workflow: ${{ github.workflow }}
            Branch: ${{ github.ref_name }}
            Trigger: ${{ github.event_name }}
            Run Number: ${{ github.run_number }}
            Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please review workflow logs and the uploaded diagnostics artifact.
          content_type: text/plain

      - name: Mail notification is not configured
        if: steps.mail_config.outputs.ready != 'true'
        run: |
          echo "Failure email skipped. Missing secrets: ${{ steps.mail_config.outputs.missing_keys }}"
